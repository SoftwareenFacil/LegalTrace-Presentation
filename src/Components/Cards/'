// HistoryCard.jsx

// External imports
import React, { useEffect, useState } from "react";
import { Card, Badge, Button, Col, Row } from 'react-bootstrap';

// Internal imports
import DateIcon from "../Icons/DateIcon";
import { getClients } from "../../Utils/getEntity";
import { fetchAndMapById } from "../../Utils/fetchEntities";

// Styles imports

const HistoryCard = ({data, category, CustomModal, onFormSubmit}) => {

  const [improvedData, setData] = useState(data);
  const [show, setShow] = useState(false);


  useEffect(() => {
    if (data.length > 0) {
      fetchClients(data);
    }
  }, [data]); 


  const fetchClients = async (data) => {
    console.log(uniqueClientIds);
    const uniqueClientIds = [data.clientId];
    const clientsMap = await fetchAndMapById(uniqueClientIds, 
                              getClients);
    const updatedData = data.map(item => ({
      ...item,
      clientName: clientsMap[item.clientId],
    }));

    setData(updatedData);
  };

  const handleClose = () => setShow(false);
  const handleShow = () => setShow(true);


  const renderIcon = (vigency, date, category) => (
    <DateIcon date={date} vigency={vigency} category={category}/>
  );

  return (
    <Card className="m-3" style={{height: '320px', width: '320px' }}>
      <div>
        <Card.Body style={{paddingLeft: '10px', paddingRight: '10px', 
            paddingBottom: '13px'}}>
           <Row> 
            <Col xs="auto">
              {renderIcon(data.finished, new Date(data.eventDate), 
                          category)}
            </Col>    
            <Col>{data.clientName}</Col>
            <Col xs="auto">
              <Badge variant="success">Activo</Badge>
            </Col>
            <Card.Title>{data.title}</Card.Title>
          </Row>
          <Card.Text>
            <div style={{
              backgroundColor: '#F2F5FC', 
              height: '125px',
              padding: '10px',
              margin: '10px 0',
              borderRadius: '10px'
            }}>
              {data.description}
            </div>
          </Card.Text>
          <div style={{ display: 'flex', flexDirection: 'column'}}>
            <div style={{marginBottom: '5px'}}>

              <Button style={{ display: 'flex', aligndatas: 'center', 
                               justifyContent: 'center', height: '36px' }}
              className="w-100" variant="primary">Ver</Button>
            </div>
            <div>
              <Button style={{ display: 'flex', alignItems: 'center', 
                               justifyContent: 'center', height: '22px' }}
                className="w-100" onClick={handleShow}
                variant="secondary">editar</Button>
            </div>
          </div>
          </Card.Body>
        <CustomModal data={data} op={'edit'}  show={show} 
          onClose={handleClose} onFormSubmit={onFormSubmit}/>
        </div>
    </Card>
  );
};

export default HistoryCard;

